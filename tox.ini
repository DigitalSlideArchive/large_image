[tox]
envlist =
  py{27,35,36,37}
  docs
  flake8
  lintclient
  lintannotationclient
skip_missing_interpreters = true
toxworkdir = {toxinidir}/build/tox

[travis]
python =
  2.7: py27
  3.5: py35
  3.6: py36
  3.7: py37, docs, flake8, lintclient, lintannotationclient

[testenv]
# install_command = pip install --upgrade --upgrade-strategy eager --find-links https://girder.github.io/large_image_wheels {opts} .[memcached] {packages}
# deps =
#   -rrequirements-dev.txt
#   coverage
#   mock
#   pytest>=3.6
#   pytest-cov>=2.6
#   pytest-girder>=3.0.4
#   pytest-xdist
whitelist_externals =
  rm
  npx
  python
  cat
commands =
  pip install numpy
  pip install coverage mock 'pytest>=3.6' 'pytest-cov>=2.6' 'pytest-girder>=3.0.4' pytest-xdist
  pip install --upgrade --upgrade-strategy eager --find-links https://girder.github.io/large_image_wheels .[memcached] -rrequirements-dev.txt
  rm -rf build/test/coverage/web_temp
  python -c 'f="build/tox/py37/lib/python3.7/site-packages/girder/api/rest.py";s=open(f, "rt").read();s=s.replace("url = url or cherrypy.url()", """import sys\n    sys.stderr.write("--> %r\\n" % [apiStr, url, url or cherrypy.url()])\n    url = url or cherrypy.url()""");open(f,"wt").write(s)'
  cat build/tox/py37/lib/python3.7/site-packages/girder/api/rest.py
  python -c 'f="build/tox/py37/lib/python3.7/site-packages/girder_worker/girder_plugin/utils.py";s=open(f, "rt").read();s=s.replace("return apiUrl or getApiUrl()", """import sys\n    sys.stderr.write("B--> %r\\n" % [apiUrl, getApiUrl()])\n    return apiUrl or getApiUrl()""");open(f,"wt").write(s)'
  cat build/tox/py37/lib/python3.7/site-packages/girder_worker/girder_plugin/utils.py
  python -c 'f="build/tox/py37/lib/python3.7/site-packages/girder_worker/utils.py";s=open(f, "rt").read();s=s.replace("self.url = url", """self.url = url\n        import sys\n        sys.stderr.write("C--> %r\\n" % [url])""");open(f,"wt").write(s)'
  python -c 'f="build/tox/py37/lib/python3.7/site-packages/girder_worker/utils.py";s=open(f, "rt").read();s=s.replace("return JobManager", """import sys\n    sys.stderr.write("D--> %r\\n" % [kwargs])\n    return JobManager""");open(f,"wt").write(s)'
  cat build/tox/py37/lib/python3.7/site-packages/girder_worker/utils.py

  girder build --dev
  pytest --cov-config setup.cfg {posargs}
  npx nyc report --temp-dir build/test/coverage/web_temp --report-dir build/test/coverage --reporter cobertura --reporter text-summary

[testenv:flake8]
skipsdist = true
skip_install = true
deps =
  flake8
  flake8-blind-except
  flake8-bugbear; python_version >= '3.5'
  flake8-docstrings
  flake8-quotes
commands = flake8 {posargs}

[testenv:lintclient]
skip_install = true
usedevelop = false
deps =
changedir = {toxinidir}/girder/girder_large_image/web_client
whitelist_externals =
  npm
commands =
  npm install --no-package-lock
  npm run lint

[testenv:lintannotationclient]
skip_install = true
usedevelop = false
deps =
changedir = {toxinidir}/girder_annotation/girder_large_image_annotation/web_client
whitelist_externals =
  npm
commands =
  npm install --no-package-lock
  npm run lint

[testenv:docs]
skip_install = true
usedevelop = false
deps =
  sphinx
  sphinx-rtd-theme
changedir = {toxinidir}/docs
whitelist_externals =
  make_docs.sh
commands =
  ./make_docs.sh
